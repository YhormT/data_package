generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Cart {
  id           Int        @id @default(autoincrement())
  userId       Int        @unique
  mobileNumber String?
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        CartItem[]

  @@map("Cart")
}

model User {
  id               Int           @id @default(autoincrement())
  name             String
  email            String        @unique
  password         String
  role             String
  createdAt        DateTime      @default(now())
  phone            String?
  loanBalance      Float         @default(0)
  hasLoan          Boolean       @default(false)
  adminLoanBalance Float?        @db.Float
  isLoggedIn       Boolean       @default(false)
  refundedTotal    Float         @default(0)
  cart             Cart?
  orders           Order[]
  TopUp            TopUp[]
  transactions     Transaction[]

  @@map("User")
}

model CartItem {
  id           Int     @id @default(autoincrement())
  cartId       Int
  quantity     Int     @default(1)
  price        Float
  productId    Int
  mobileNumber String?
  cart         Cart    @relation(fields: [cartId], references: [id], onDelete: NoAction)
  product      Product @relation(fields: [productId], references: [id], onDelete: NoAction)

  @@index([cartId], map: "CartItem_cartId_fkey")
  @@index([productId], map: "CartItem_productId_fkey")
  @@map("CartItem")
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  price       Float
  stock       Int         @default(0)
  showInShop  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  CartItem    CartItem[]
  OrderItem   OrderItem[]

  @@map("Product")
}

model Order {
  id           Int         @id @default(autoincrement())
  userId       Int
  createdAt    DateTime    @default(now())
  status       String      @default("Pending")
  mobileNumber String?
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        OrderItem[]

  @@index([userId], map: "Order_userId_fkey")
  @@map("Order")
}

model OrderItem {
  id           Int     @id @default(autoincrement())
  orderId      Int
  productId    Int
  quantity     Int
  mobileNumber String?
  status       String  @default("Pending")
  order        Order   @relation(fields: [orderId], references: [id], onDelete: NoAction)
  product      Product @relation(fields: [productId], references: [id], onDelete: NoAction)

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
  @@map("OrderItem")
}

model TopUp {
  id          Int      @id @default(autoincrement())
  userId      Int
  referenceId String   @unique
  amount      Float
  status      String   @default("Pending")
  submittedBy String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "TopUp_userId_fkey")
  @@map("TopUp")
}

model Upload {
  id         Int        @id @default(autoincrement())
  filename   String     @db.VarChar(255)
  filePath   String?    @db.VarChar(255)
  uploadedAt DateTime?  @db.DateTime(0)
  userId     String?    @db.VarChar(255)
  purchases  Purchase[]

  @@map("Upload")
}

model Purchase {
  id              Int    @id @default(autoincrement())
  phone           String @db.VarChar(20)
  price           String @db.VarChar(100)
  itemDescription String @db.Text
  uploadedFileId  Int
  uploadedFile    Upload @relation(fields: [uploadedFileId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([uploadedFileId], map: "uploaded_file_id")
  @@map("Purchase")
}

model Transaction {
  id              Int       @id @default(autoincrement())
  userId          Int
  amount          Float
  balance         Float
  type            String
  description     String    @db.Text
  reference       String?   @db.VarChar(255)
  createdAt       DateTime? @default(now())
  previousBalance Float     @default(0)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_transaction")

  @@index([userId], map: "fk_user_transaction")
  @@map("Transaction")
}

model Announcement {
  id             String             @id @default(cuid())
  title          String             @db.VarChar(500)
  message        String             @db.Text
  isActive       Boolean            @default(true)
  priority       Int                @default(1)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @default(now()) @updatedAt
  createdBy      String
  target         String             @default("login") // login, shop, all
  targetAudience String             @default("all") // all, shop, premium, normal, super, other, user
  readBy         NotificationRead[]

  @@map("Announcements")
}

model NotificationRead {
  id             Int          @id @default(autoincrement())
  announcementId String
  userId         Int
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([userId])
  @@map("NotificationRead")
}

model Complaint {
  id              Int      @id @default(autoincrement())
  orderId         String?
  mobileNumber    String   @db.VarChar(20)
  whatsappNumber  String?  @db.VarChar(20)
  message         String   @db.Text
  status          String   @default("pending") // pending, reviewed, resolved
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  adminNotes      String?  @db.Text

  @@map("Complaint")
}

model SmsMessage {
  id          Int      @id @default(autoincrement())
  phoneNumber String   @db.VarChar(20)
  message     String   @db.Text
  reference   String?  @db.VarChar(255)
  amount      Float?
  isProcessed Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@map("SmsMessage")
}

model PaymentTransaction {
  id               Int      @id @default(autoincrement())
  externalRef      String   @unique @db.VarChar(255)
  mobileNumber     String   @db.VarChar(20)
  amount           Float
  currency         String   @default("GHS") @db.VarChar(10)
  channel          String   @db.VarChar(50)
  status           String   @db.VarChar(50)
  productId        Int?
  productName      String?  @db.VarChar(255)
  orderId          Int?
  moolreCode       String?  @db.VarChar(255)
  moolreMessage    String?  @db.Text
  moolreSessionId  String?  @db.VarChar(255)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt

  @@index([externalRef], map: "PaymentTransaction_externalRef_idx")
  @@index([mobileNumber], map: "PaymentTransaction_mobileNumber_idx")
  @@index([status], map: "PaymentTransaction_status_idx")
  @@map("PaymentTransaction")
}
